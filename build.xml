<project name="JBrowse" default="Installation" basedir=".">

  <!-- ooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo -->
  <!-- oooooooooooooooooooooooooo  Dependencies  oooooooooooooooooooooooooo -->
  <!-- oooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo -->

  <!-- oooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo -->
  <!-- oooooooooooooooooooooooooo    Checkout    oooooooooooooooooooooooooo -->
  <!-- oooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo -->

  <target name="JBrowse-ChildCheckout" />
  
  <!-- oooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo -->
  <!-- oooooooooooooooooooooooooo    Update    oooooooooooooooooooooooooo -->
  <!-- oooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo -->

  <target name="JBrowse-ChildUpdate" />

  <!-- oooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo -->
  <!-- oooooooooooooooooooooooooo  Installation  oooooooooooooooooooooooooo -->
  <!-- oooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo -->

  <target name="JBrowse-Installation" depends="JBrowse/Model-Installation">

    <ant target="defaultProjectInstall">
      <property name="project" value="JBrowse"/>
    </ant>

  </target>
  
  <target name="JBrowse-WebInstallation" depends="JBrowse-Installation">

    <!-- yarn install GMOD/jbrowse -->
    <exec executable="yarn"
      dir="${projectsDir}/${project}"
      failonerror="true"
      failifexecutionfails="true">
           <arg line="install"/>
    </exec>

    <!-- multibigwig plugin -->

    <unzip src="${projectsDir}/${project}/plugins/multibigwig.zip" 
           dest="${projectsDir}/${project}/plugins/"/>
    <move todir="${projectsDir}/${project}/node_modules/@gmod/jbrowse/plugins/MultiBigWig">
      <fileset dir="${projectsDir}/${project}/plugins/multibigwig-master"/>
    </move>

    <!-- cannot use ant copy because file permissions are not retained -->
    <exec executable="cp"
      dir="${projectsDir}/${project}"
      failonerror="true"
      failifexecutionfails="true">
           <arg line="-r"/>
           <arg line="${projectsDir}/${project}/node_modules/@gmod/jbrowse"/>
           <arg line="${webappTargetDir}/jbrowse"/>
    </exec>

    <!-- setup.sh -->
    <exec executable="/bin/bash"
      dir="${webappTargetDir}/jbrowse"
      failonerror="true"
      failifexecutionfails="true">
           <arg line="setup.sh"/>
    </exec>

    <delete file="${webappTargetDir}/jbrowse/index.html"/>
    <delete file="${webappTargetDir}/jbrowse/jbrowse.conf"/>
    <delete dir="${webappTargetDir}/jbrowse/node_modules"/>

    <delete dir="${webappTargetDir}/jbrowse/eupath_data" followsymlinks="false" removeNotFollowedSymlinks="true"/>

    <mkdir dir="${webappTargetDir}/jbrowse/eupath_data"/>

    <copy file="${projectsDir}/${project}/Model/conf/jbrowse.conf" tofile="${webappTargetDir}/jbrowse/jbrowse.conf"/>
    <copy file="${projectsDir}/${project}/Model/conf/functions.conf" tofile="${webappTargetDir}/jbrowse/functions.conf"/>
    <copy file="${projectsDir}/${project}/Site/htdocs/index.html" tofile="${webappTargetDir}/jbrowse/index.html"/>
    <copy file="${projectsDir}/${project}/Site/htdocs/apiGBrowsePopups.js" tofile="${webappTargetDir}/jbrowse/apiGBrowsePopups.js"/>

    <symlink link="${webappTargetDir}/jbrowse/eupath_data/webServices" resource="/var/www/Common/apiSiteFilesMirror/webServices"/>
    <symlink link="${webappTargetDir}/jbrowse/eupath_data/auxiliary" resource="/var/www/Common/apiSiteFilesMirror/auxiliary"/>

    <symlink link="${webappTargetDir}/jbrowse/tracks" resource="${targetDir}/lib/jbrowse/auto_generated"/>

  </target>
  
  <!-- oooooooooooooooooo  Installation Postprocess  ooooooooooooooooooooo -->

  <target name="JBrowse-Installation-postprocess"/>

  <!-- ooooooooooooooooooooooo  Install Components  ooooooooooooooooooooooo -->


  <target name="JBrowse/Model-Installation" depends="ProjectTree">

    <ant target="defaultComponentInstall">
      <property name="project" value="JBrowse"/>
      <property name="component" value="Model"/>
    </ant>

  </target>  



  <!-- oooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo -->
  <!-- oooooooooooooooooooooooooooo  Release  ooooooooooooooooooooooooooooo -->
  <!-- oooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo -->

  <target name="JBrowse-Release"/>

  <target name="ProjectTree" if="${checkout}">
    <ant target="projectCheckOut"/>
  </target>  


</project>

